# ========================================
# HARDENED DOCKER COMPOSE - POST-BREACH
# Zero Trust Architecture Implementation
# ========================================

services:
  # ========================================
  # POSTGRESQL - CMS DATABASE
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: postgres_coradir_cms
    restart: unless-stopped

    # Security: Run as non-root user
    user: "999:999"

    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Security: Drop ALL capabilities
    cap_drop:
      - ALL

    # Security: Additional security options
    security_opt:
      - no-new-privileges:true

    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=coradir_cms

    volumes:
      - postgres_data:/var/lib/postgresql/data

    networks:
      - coradir_internal

    # Expose PostgreSQL port for local development only
    ports:
      - "5432:5432"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d coradir_cms"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # STRAPI CMS
  # ========================================
  strapi:
    build:
      context: ./strapi
      dockerfile: Dockerfile
    container_name: strapi_coradir_cms
    restart: unless-stopped

    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Security: Drop ALL capabilities
    cap_drop:
      - ALL

    # Security: Additional security options
    security_opt:
      - no-new-privileges:true

    environment:
      - NODE_ENV=production
      - DATABASE_CLIENT=postgres
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=coradir_cms
      - DATABASE_USERNAME=${POSTGRES_USER}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - DATABASE_SSL=false
      - JWT_SECRET=${STRAPI_JWT_SECRET}
      - API_TOKEN_SALT=${STRAPI_API_TOKEN_SALT}
      - ADMIN_JWT_SECRET=${STRAPI_ADMIN_JWT_SECRET}
      - TRANSFER_TOKEN_SALT=${STRAPI_TRANSFER_TOKEN_SALT}
      - APP_KEYS=${STRAPI_APP_KEYS}
      - STRAPI_ADMIN_CLIENT_URL=http://localhost:1337
      - STRAPI_ADMIN_CLIENT_PREVIEW_SECRET=${STRAPI_PREVIEW_SECRET}

    volumes:
      - strapi_uploads:/opt/app/public/uploads

    networks:
      - coradir_internal

    depends_on:
      postgres:
        condition: service_healthy

    ports:
      - "1337:1337"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:1337/_health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_N8N_WEBHOOK_URL=${NEXT_PUBLIC_N8N_WEBHOOK_URL}
        - NEXT_PUBLIC_RECAPTCHA_SITE_KEY=${NEXT_PUBLIC_RECAPTCHA_SITE_KEY}
        - NEXT_PUBLIC_BOT_SCRIPT_URL=${NEXT_PUBLIC_BOT_SCRIPT_URL}
        - NEXT_PUBLIC_STRAPI_URL=${NEXT_PUBLIC_STRAPI_URL}

    container_name: web_coradir_homes

    # ========================================
    # SECURITY HARDENING
    # ========================================

    # Security: Read-only root filesystem prevents malware from writing files
    read_only: true

    # Security: Temporary filesystem in memory only (cleared on restart)
    tmpfs:
      - /tmp:size=64M,mode=1777,uid=1001,gid=1001,noexec,nosuid,nodev
      - /app/.next/cache:size=128M,mode=0755,uid=1001,gid=1001,noexec,nosuid,nodev

    # Security: Drop ALL Linux capabilities
    cap_drop:
      - ALL

    # Security: Additional security options
    security_opt:
      - no-new-privileges:true  # Prevents privilege escalation
      - seccomp:unconfined      # Adjust if you have a custom seccomp profile

    # Security: Resource limits to prevent DoS
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2048M
        reservations:
          cpus: '0.5'
          memory: 512M

    # ========================================
    # NETWORK & CONNECTIVITY
    # ========================================
    networks:
      - caddy
      - coradir_internal

    depends_on:
      strapi:
        condition: service_healthy

    restart: unless-stopped

    ports:
      - "6118:6118"

    labels:
      - caddy=${APP_DOMAIN}
      - caddy.reverse_proxy="{{upstreams 6118}}"

    # ========================================
    # ENVIRONMENT VARIABLES
    # ========================================
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=1536
      - NEXT_PUBLIC_N8N_WEBHOOK_URL=${NEXT_PUBLIC_N8N_WEBHOOK_URL}
      - NEXT_PUBLIC_RECAPTCHA_SITE_KEY=${NEXT_PUBLIC_RECAPTCHA_SITE_KEY}
      - RECAPTCHA_PROJECT_ID=${RECAPTCHA_PROJECT_ID}
      - RECAPTCHA_API_KEY=${RECAPTCHA_API_KEY}
      - RECAPTCHA_MIN_SCORE=${RECAPTCHA_MIN_SCORE:-0.5}
      - NEXT_PUBLIC_BOT_SCRIPT_URL=${NEXT_PUBLIC_BOT_SCRIPT_URL}
      - NEXT_PUBLIC_STRAPI_URL=${NEXT_PUBLIC_STRAPI_URL}
      - STRAPI_API_TOKEN=${STRAPI_API_TOKEN}

    # ========================================
    # HEALTH CHECK
    # ========================================
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:6118/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  caddy:
    name: caddy
    external: true
  coradir_internal:
    driver: bridge
    internal: false

volumes:
  postgres_data:
    driver: local
  strapi_uploads:
    driver: local
